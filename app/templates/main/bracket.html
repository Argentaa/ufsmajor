{% extends "base.html" %}

{% block title %}Chave do Torneio - UFSMAJOR{% endblock %}

{% block styles %}
<style>
    body {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }
    .bracket-container {
        display: flex;
        justify-content: space-around;
        align-items: center; /* Alinha as colunas verticalmente */
    }
    .round-column {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        flex: 1;
        padding: 0 1rem;
        height: 100%; /* Garante que as colunas se estiquem */
    }
    .match-card {
        background-color: #2c2c2c;
        border: 1px solid #444;
        border-radius: 8px;
        margin: 20px 0;
        padding: 1rem;
        position: relative;
        transition: all 0.2s ease-in-out; /* Transi√ß√£o para as mudan√ßas */
        min-height: 120px; /* Altura m√≠nima para alinhamento */
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
    }
    .match-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }
    .team {
        position: relative;
        padding: 0.5rem 0;
        font-weight: bold;
        font-size: 1.1rem;
    }
    .team.winner {
        color: #28a745; /* Verde Sucesso */
    }
    .team.loser {
        color: #dc3545; /* Vermelho Perigo */
        opacity: 0.6;
    }
    .team .players-tooltip {
        visibility: hidden;
        width: max-content;
        background-color: #000;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.9rem;
        pointer-events: none; /* Impede que o tooltip interfira no hover */
    }
    .team:hover .players-tooltip {
        visibility: visible;
        opacity: 1;
    }
    .vs-separator {
        color: #ffc107; /* Amarelo Bootstrap */
        font-weight: bold;
        margin: 0.2rem 0;
    }
    .round-title {
        text-align: center;
        font-weight: bold;
        font-size: 1.5rem;
        color: #ffc107;
        margin-bottom: 2rem;
    }
    .champion-card {
        text-align: center;
        background-color: #2c2c2c;
        padding: 1.5rem;
    }
    .champion-name {
        font-size: 2rem;
        color: #ffc107;
        font-weight: bold;
    }
    
    /* --- MEDIA QUERY PARA RESPONSIVIDADE --- */
    @media (max-width: 768px) {
        .bracket-container {
            flex-direction: column; /* Empilha as colunas verticalmente */
        }
        .round-column {
            width: 100%; /* Faz as colunas ocuparem toda a largura */
            padding: 0;
            margin-bottom: 2rem;
        }
        .match-card {
            margin: 10px 0;
        }
    }
</style>
{% endblock %}


{% block content %}
<div class="text-center mb-4">
    <img src="{{ url_for('static', filename='img/ufsmajor-semfundo.png') }}" alt="Logo UFSMAJOR" class="img-fluid" style="max-width: 200px;">
</div>

<div id="bracket-container" class="bracket-container">
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Flag para controlar se a estrutura inicial j√° foi renderizada
    let isBracketInitialized = false;

    function createTeamElement(team, winnerName) {
        if (!team || !team.name) {
            return '<div class="team text-muted">Aguardando...</div>';
        }
        const isWinner = winnerName === team.name;
        const teamClass = winnerName ? (isWinner ? 'winner' : 'loser') : '';
        const playersTooltip = team.players.map(p => p.name).join('<br>');
        return `
            <div class="team ${teamClass}">
                ${team.name}
                <div class="players-tooltip">${playersTooltip}</div>
            </div>
        `;
    }

    // --- NOVA FUN√á√ÉO PARA GERAR APENAS O CONTE√öDO INTERNO DE UM CARD ---
    function createMatchCardInnerHtml(match) {
        const winnerName = match.winner ? match.winner.name : null;
        return `
            ${createTeamElement(match.team1, winnerName)}
            <div class="vs-separator">vs</div>
            ${createTeamElement(match.team2, winnerName)}
        `;
    }

    async function updateBracket() {
        try {
            const response = await fetch('/api/bracket-status');
            if (!response.ok) return;
            const matches = await response.json();
            const bracketContainer = document.getElementById('bracket-container');

            if (matches.length === 0 && !isBracketInitialized) {
                bracketContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">A chave do torneio ainda n√£o foi gerada. Volte mais tarde!</div></div>';
                return;
            }

            // --- L√ìGICA DE ATUALIZA√á√ÉO N√ÉO-DESTRUTIVA ---
            if (isBracketInitialized) {
                // Se j√° foi inicializado, apenas atualiza o conte√∫do
                matches.forEach(match => {
                    const matchCardEl = document.getElementById(`match-${match.id}`);
                    if (matchCardEl) {
                        const newHtml = createMatchCardInnerHtml(match);
                        // Atualiza o HTML apenas se ele mudou para evitar repinturas desnecess√°rias
                        if (matchCardEl.innerHTML.trim() !== newHtml.trim()) {
                            matchCardEl.innerHTML = newHtml;
                        }
                    }
                });

                // Atualiza o campe√£o
                const championCardEl = document.getElementById('champion-card-content');
                const finalMatch = matches.find(m => m.round_number === 3);
                const finalWinnerName = finalMatch && finalMatch.winner ? finalMatch.winner.name : null;
                
                let championHtml = '<span class="text-muted">Aguardando...</span>';
                if (finalWinnerName) {
                    championHtml = `<span class="champion-name">${finalWinnerName}</span>`;
                }

                if (championCardEl && championCardEl.innerHTML.trim() !== championHtml.trim()) {
                    championCardEl.innerHTML = championHtml;
                }

            } else {
                // --- L√ìGICA DE CONSTRU√á√ÉO INICIAL (executa apenas uma vez) ---
                bracketContainer.innerHTML = ''; 

                const rounds = { 1: [], 2: [], 3: [] };
                matches.forEach(m => {
                    if(rounds[m.round_number]) rounds[m.round_number].push(m);
                });
                
                function createMatchCard(match) {
                    const matchCard = document.createElement('div');
                    matchCard.className = 'match-card';
                    matchCard.id = `match-${match.id}`; // Adiciona um ID √∫nico
                    matchCard.innerHTML = createMatchCardInnerHtml(match);
                    return matchCard;
                }

                function createColumn(title, matchesList) {
                    const col = document.createElement('div');
                    col.className = 'round-column';
                    col.innerHTML = `<h5 class="round-title">${title}</h5>`;
                    matchesList.forEach(match => col.appendChild(createMatchCard(match)));
                    return col;
                }
                
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    bracketContainer.appendChild(createColumn('Quartas', rounds[1]));
                    bracketContainer.appendChild(createColumn('Semifinais', rounds[2]));
                    const finalColumn = createColumn('Final', rounds[3]);
                    const championCard = document.createElement('div');
                    championCard.className = 'match-card champion-card';
                    const finalWinnerName = rounds[3][0] && rounds[3][0].winner ? rounds[3][0].winner.name : null;
                    let championContent = finalWinnerName ? `<span class="champion-name">${finalWinnerName}</span>` : '<span class="text-muted">Aguardando...</span>';
                    championCard.innerHTML = `<h5 class="round-title" style="margin-bottom: 0.5rem;">üèÜ Campe√£o üèÜ</h5><div id="champion-card-content">${championContent}</div>`;
                    finalColumn.appendChild(championCard);
                    bracketContainer.appendChild(finalColumn);
                } else {
                    const leftQuarters = rounds[1].slice(0, 2);
                    const rightQuarters = rounds[1].slice(2, 4);
                    const leftSemi = rounds[2].slice(0, 1);
                    const rightSemi = rounds[2].slice(1, 2);

                    bracketContainer.appendChild(createColumn('Quartas', leftQuarters));
                    bracketContainer.appendChild(createColumn('Semifinais', leftSemi));
                    
                    const finalColumn = createColumn('Final', rounds[3]);
                    const championCard = document.createElement('div');
                    championCard.className = 'match-card champion-card';
                    const finalWinnerName = rounds[3][0] && rounds[3][0].winner ? rounds[3][0].winner.name : null;
                    let championContent = finalWinnerName ? `<span class="champion-name">${finalWinnerName}</span>` : '<span class="text-muted">Aguardando...</span>';
                    championCard.innerHTML = `<h5 class="round-title" style="margin-bottom: 0.5rem;">üèÜCampe√£oüèÜ</h5><div id="champion-card-content">${championContent}</div>`;
                    finalColumn.appendChild(championCard);
                    bracketContainer.appendChild(finalColumn);

                    bracketContainer.appendChild(createColumn('Semifinais', rightSemi));
                    bracketContainer.appendChild(createColumn('Quartas', rightQuarters));
                }

                isBracketInitialized = true; // Marca como inicializado
            }

        } catch (error) {
            console.error('Erro ao atualizar a chave:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateBracket();
        setInterval(updateBracket, 5000);
    });
</script>
{% endblock %}